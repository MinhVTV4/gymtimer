<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·ªô ƒë·∫øm gi·ªù t·∫≠p luy·ªán Linh ho·∫°t</title>
    <style>
        /* ===== CSS START ===== */
        body {
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            background-color: #fff;
            padding: 20px 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 100%;
            max-width: 550px; /* Chi·ªÅu r·ªông t·ªëi ƒëa kh√¥ng ƒë·ªïi */
            position: relative;
            overflow: hidden;
        }

        .page { display: none; }
        .page.active { display: block; }

        h1, h2 { color: #333; margin-bottom: 20px; font-size: 24px; }
        h2 { margin-top: 30px; margin-bottom: 15px; font-size: 22px; border-top: 1px solid #eee; padding-top: 15px; }
        h3 { color: #555; margin-top: 20px; margin-bottom: 10px; font-size: 18px; }
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; font-size: 0.9em; }
        .input-group input[type="number"],
        .input-group input[type="text"],
        .input-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
            margin-top: 3px;
        }
        .input-group.inline { display: flex; align-items: center; gap: 10px; }
        .input-group.inline label { flex-shrink: 0; margin-bottom: 0; }
        .input-group.inline input { flex-grow: 1; }
        .input-group.text-center { text-align: center; }

        /* --- Mode Selection --- */
        .mode-selection { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; text-align: left; }
        .mode-selection label { margin-right: 15px; font-weight: normal; }
        .mode-selection input[type="radio"] { margin-right: 5px; }

        /* --- Setup Options Sections --- */
        .setup-options { display: none; }
        .setup-options.active { display: block; }

        /* --- Exercise List Setup --- */
        #exerciseListContainer { border: 1px solid #eee; border-radius: 4px; padding: 10px; margin-bottom: 15px; max-height: 200px; overflow-y: auto; }
        .exercise-item { display: flex; gap: 8px; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px dashed #eee; }
        .exercise-item:last-child { margin-bottom: 0; border-bottom: none; padding-bottom: 0; }
        .exercise-item input[type="text"] { flex-grow: 1; min-width: 100px; }
        .exercise-item input[type="number"] { width: 80px; flex-shrink: 0; text-align: right; }
        .exercise-item button { padding: 5px 8px; font-size: 12px; background-color: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer; line-height: 1; }
        .exercise-item button:hover { background-color: #c82333; }
        .exercise-controls { display: flex; justify-content: center; gap: 10px; margin-top: 10px; }

        /* --- Display Area --- */
        .display-area { margin-top: 25px; margin-bottom: 25px; border-top: 1px solid #eee; padding-top: 20px; }
        .workout-details { font-size: 0.95em; color: #555; margin-bottom: 10px; }
        .status { font-size: 1.1em; color: #555; min-height: 1.2em; font-weight: bold; margin-bottom: 5px; }
        #exerciseNameDisplay { font-size: 1.2em; color: #0056b3; font-weight: bold; margin-bottom: 10px; min-height: 1.3em; }

        /* --- Timer Display (UPDATED) --- */
        .timer {
            /* font-size: 4.5em; */ /* D√≤ng c≈© */
            font-size: 9em;   /* TƒÉng g·∫•p ƒë√¥i */
            font-weight: bold;
            color: #333;
            margin-top: 0;
            margin-bottom: 10px; /* Gi·∫£m margin d∆∞·ªõi m·ªôt ch√∫t ƒë·ªÉ b√π l·∫°i font l·ªõn h∆°n */
            min-height: 1.1em;  /* Gi·∫£m min-height v√¨ font l·ªõn ƒë√£ ƒë·ªß cao */
            line-height: 1; /* Gi√∫p ki·ªÉm so√°t chi·ªÅu cao d√≤ng t·ªët h∆°n */
            transition: color 0.2s ease-in-out;
            overflow: hidden; /* ƒê·∫£m b·∫£o s·ªë qu√° l·ªõn kh√¥ng l√†m v·ª° layout ngang */
            text-align: center; /* ƒê·∫£m b·∫£o s·ªë lu√¥n cƒÉn gi·ªØa */
        }
        /* Phase Colors (Gi·ªØ nguy√™n) */
        .timer.phase-warmup { color: #17a2b8; }
        .timer.phase-exercise { color: #28a745; }
        .timer.phase-rest { color: #ffc107; }
        .timer.phase-roundRest { color: #fd7e14; }
        .timer.phase-cooldown { color: #6610f2; }
        .timer.phase-ready { color: #17a2b8; }
        .timer.paused { color: #6c757d !important; }
        .timer.warning { color: #dc3545 !important; }

        /* --- Workout Info & Progress Bars (Gi·ªØ nguy√™n) --- */
        .workout-info { display: flex; justify-content: space-around; font-size: 0.9em; color: #555; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed #eee; }
        .workout-info p { margin: 0 5px; }
        .workout-info span { font-weight: bold; }
        .progress-container { margin-top: 10px; margin-bottom: 10px; }
        .progress-label { font-size: 12px; color: #555; text-align: left; margin-bottom: 3px; display: block; }
        progress { width: 100%; height: 8px; appearance: none; border: none; border-radius: 5px; overflow: hidden; background-color: #e9ecef; }
        progress::-webkit-progress-bar { background-color: #e9ecef; border-radius: 5px; }
        progress::-webkit-progress-value { background-color: #007bff; border-radius: 5px; transition: width 0.1s linear; }
        progress::-moz-progress-bar { background-color: #007bff; border-radius: 5px; transition: width 0.1s linear; }
        #overallProgress::-webkit-progress-value { background-color: #28a745; }
        #overallProgress::-moz-progress-bar { background-color: #28a745; }

        /* --- Buttons (Gi·ªØ nguy√™n) --- */
        .controls, .save-load-controls, .setup-actions, .secondary-controls { margin-top: 20px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
        .secondary-controls { margin-top: 10px; }
        .controls button, .save-load-controls button, .setup-actions button, .exercise-controls button, .btn-secondary { padding: 10px 15px; font-size: 15px; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.2s ease, opacity 0.2s ease; color: white; line-height: 1.4; }
        .exercise-controls button { padding: 8px 12px; font-size: 14px; }
        .btn-secondary { background-color: #6c757d; } .btn-secondary:hover:not(:disabled) { background-color: #5a6268; } .btn-secondary.muted { background-color: #dc3545; } .btn-secondary.muted:hover:not(:disabled) { background-color: #c82333; }
        #goToWorkoutButton, #startButton, .btn-add-exercise { background-color: #28a745; } #goToWorkoutButton:hover:not(:disabled), #startButton:hover:not(:disabled), .btn-add-exercise:hover:not(:disabled) { background-color: #218838; } #pauseButton { background-color: #ffc107; } #pauseButton:hover:not(:disabled) { background-color: #e0a800; } #resetButton, #deleteRoutineButton, .btn-remove-exercise { background-color: #dc3545; } #resetButton:hover:not(:disabled), #deleteRoutineButton:hover:not(:disabled), .btn-remove-exercise:hover:not(:disabled) { background-color: #c82333; } #skipButton { background-color: #17a2b8; } #skipButton:hover:not(:disabled) { background-color: #138496; } #saveRoutineButton { background-color: #007bff; } #saveRoutineButton:hover:not(:disabled) { background-color: #0069d9; } #loadRoutineButton { background-color: #17a2b8; } #loadRoutineButton:hover:not(:disabled) { background-color: #138496; }
        button:disabled { opacity: 0.65; cursor: not-allowed !important; }

        /* --- History Section (Gi·ªØ nguy√™n) --- */
        #historyList { list-style: none; padding: 0; text-align: left; max-height: 180px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-top: 15px; border-radius: 4px; }
        #historyList li { background-color: #f8f9fa; padding: 8px 12px; border-bottom: 1px solid #dee2e6; margin-bottom: 6px; border-radius: 4px; font-size: 0.85em; word-break: break-word; }
        #historyList li:last-child { border-bottom: none; margin-bottom: 0; }
        #historyList strong { display: block; margin-bottom: 3px; font-size: 0.9em; color: #495057;}
        #historyList .history-details { font-size: 0.9em; color: #6c757d; }

        .hidden { display: none !important; }

        /* Style for loaded routine info (Gi·ªØ nguy√™n) */
        #loadedRoutineInfo { margin-top: 20px; padding: 10px; background-color: #e9f7ef; border: 1px solid #bce8c8; border-radius: 4px; color: #285b38; font-size: 0.95em; }
        #loadedRoutineInfo strong { font-weight: bold; }
        #clearAndShowInputButton { margin-top: 0; /* Reset margin if needed */ }
        /* ===== CSS END ===== */
    </style>
</head>
<body>

    <div class="container">

        <div id="setupPage" class="page active">
            <h1>C√†i ƒë·∫∑t B√†i t·∫≠p</h1>

            <h3>1. Ch·ªçn c·∫•u h√¨nh ƒë√£ l∆∞u (T√πy ch·ªçn)</h3>
            <div class="input-group">
                <label for="savedRoutinesSelect">Danh s√°ch c·∫•u h√¨nh:</label>
                <select id="savedRoutinesSelect">
                    <option value="">-- Ch·ªçn ho·∫∑c Nh·∫≠p m·ªõi --</option>
                </select>
            </div>
            <div class="save-load-controls">
                <button id="loadRoutineButton" disabled>T·∫£i c·∫•u h√¨nh</button>
                <button id="deleteRoutineButton" disabled>X√≥a c·∫•u h√¨nh ƒë√£ ch·ªçn</button>
                <button id="clearAndShowInputButton" class="btn-secondary">Nh·∫≠p c·∫•u h√¨nh m·ªõi</button>
            </div>

             <p id="loadedRoutineInfo" class="hidden"></p>


            <div id="newWorkoutParamsSection">
                <h3 style="border-top: 1px solid #eee; padding-top: 20px;">2. Nh·∫≠p th√¥ng s·ªë m·ªõi</h3>
                <div class="input-group">
                     <label for="routineNameInput">T√™n c·∫•u h√¨nh (ƒë·ªÉ l∆∞u):</label>
                     <input type="text" id="routineNameInput" placeholder="VD: B√†i t·∫≠p bu·ªïi s√°ng">
                </div>
                <div class="mode-selection">
                     <strong>Ch·∫ø ƒë·ªô nh·∫≠p b√†i t·∫≠p:</strong><br>
                     <label><input type="radio" name="setupMode" value="simple" checked> ƒê∆°n gi·∫£n</label>
                     <label><input type="radio" name="setupMode" value="advanced"> N√¢ng cao</label>
                </div>
                <div id="simpleSetupOptions" class="setup-options active">
                    <h4>Th√¥ng s·ªë ch·∫ø ƒë·ªô ƒê∆°n gi·∫£n</h4>
                     <div class="input-group">
                         <label for="simpleTotalExercisesInput">T·ªïng s·ªë b√†i t·∫≠p:</label>
                         <input type="number" id="simpleTotalExercisesInput" min="1" value="5" placeholder="VD: 5">
                     </div>
                     <div class="input-group">
                         <label for="simpleExerciseDurationInput">Th·ªùi gian m·ªói b√†i (gi√¢y):</label>
                         <input type="number" id="simpleExerciseDurationInput" min="1" value="45" placeholder="VD: 45">
                     </div>
                </div>
                <div id="advancedSetupOptions" class="setup-options">
                    <h4>Th√¥ng s·ªë ch·∫ø ƒë·ªô N√¢ng cao</h4>
                     <div class="input-group">
                         <label>Danh s√°ch b√†i t·∫≠p (T√™n v√† Th·ªùi gian):</label>
                         <div id="exerciseListContainer"></div>
                         <div class="exercise-controls">
                              <button id="addExerciseButton" class="btn-add-exercise">Th√™m B√†i t·∫≠p</button>
                              <button id="removeLastExerciseButton" class="btn-remove-exercise">X√≥a B√†i Cu·ªëi</button>
                         </div>
                     </div>
                </div>
                <h4 style="margin-top: 20px; border-top: 1px dashed #ccc; padding-top: 15px;">T√πy ch·ªçn chung</h4>
                <div class="input-group">
                    <label for="restDurationInput">Th·ªùi gian ngh·ªâ sau m·ªói b√†i (gi√¢y):</label>
                    <input type="number" id="restDurationInput" min="0" value="15" placeholder="VD: 15">
                </div>
                <div class="input-group">
                    <label for="totalRoundsInput">S·ªë v√≤ng t·∫≠p:</label>
                    <input type="number" id="totalRoundsInput" min="1" value="1" placeholder="VD: 3">
                </div>
                <div class="input-group">
                    <label for="restBetweenRoundsInput">Ngh·ªâ gi·ªØa c√°c v√≤ng (gi√¢y, t√πy ch·ªçn):</label>
                    <input type="number" id="restBetweenRoundsInput" min="0" value="60" placeholder="VD: 60">
                </div>
                <div class="input-group">
                    <label for="warmupDurationInput">Th·ªùi gian kh·ªüi ƒë·ªông (gi√¢y, t√πy ch·ªçn):</label>
                    <input type="number" id="warmupDurationInput" min="0" value="0" placeholder="VD: 120">
                </div>
                <div class="input-group">
                    <label for="cooldownDurationInput">Th·ªùi gian gi√£n c∆° (gi√¢y, t√πy ch·ªçn):</label>
                    <input type="number" id="cooldownDurationInput" min="0" value="0" placeholder="VD: 180">
                </div>
                 <div class="save-load-controls" style="margin-top: 25px;">
                     <button id="saveRoutineButton">L∆∞u c·∫•u h√¨nh n√†y</button>
                 </div>
            </div>


            <div class="setup-actions" style="border-top: 1px solid #ccc; padding-top: 20px; margin-top: 25px;">
                <button id="goToWorkoutButton">Chu·∫©n b·ªã T·∫≠p &rarr;</button>
            </div>
        </div>

        <div id="workoutPage" class="page">
              <h2>Qu√° tr√¨nh T·∫≠p luy·ªán</h2>
              <div class="display-area">
                  <div class="workout-info"> <p>T·ªïng ∆Ø·ªõc t√≠nh: <span id="estimatedTimeDisplay">--:--</span></p> <p>ƒê√£ qua: <span id="elapsedTimeDisplay">00:00</span></p> <p>V√≤ng: <span id="roundDisplay">--/--</span></p> </div>
                   <p id="statusDisplay" class="status">ƒêang t·∫£i...</p> <h3 id="exerciseNameDisplay"></h3>
                  <div id="timerDisplay" class="timer">0</div> <div class="progress-container"> <label for="currentProgress" class="progress-label">Ti·∫øn tr√¨nh Pha Hi·ªán t·∫°i:</label> <progress id="currentProgress" value="0" max="100"></progress> </div>
                  <div class="progress-container"> <label for="overallProgress" class="progress-label">Ti·∫øn tr√¨nh T·ªïng th·ªÉ:</label> <progress id="overallProgress" value="0" max="100"></progress> </div>
              </div>
              <div class="controls"> <button id="startButton">B·∫Øt ƒë·∫ßu T·∫≠p</button> <button id="pauseButton" class="hidden">T·∫°m d·ª´ng</button> <button id="resetButton" disabled>D·ª´ng & ƒê·∫∑t l·∫°i</button> <button id="skipButton" class="hidden">B·ªè qua Pha</button> </div>
              <div class="controls secondary-controls"> <button id="muteButton" class="btn-secondary">T·∫Øt √Çm</button> <button id="backToSetupButton" class="hidden btn-secondary">Quay l·∫°i C√†i ƒë·∫∑t</button> </div>
              <h2>L·ªãch s·ª≠ t·∫≠p luy·ªán</h2> <ul id="historyList"> <li>Ch∆∞a c√≥ l·ªãch s·ª≠ n√†o.</li> </ul>
         </div>

        <audio id="bellSound" src="https://cdn.freesound.org/previews/263/263131_2064400-lq.mp3" preload="auto"></audio>

    </div>

    <script>
        // ===== JAVASCRIPT START =====
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Initializing Flexible Workout Timer v2 - Final");

            // --- DOM Elements (Gi·ªØ nguy√™n) ---
            const setupPage = document.getElementById('setupPage'); const workoutPage = document.getElementById('workoutPage'); const newWorkoutParamsSection = document.getElementById('newWorkoutParamsSection'); const loadedRoutineInfo = document.getElementById('loadedRoutineInfo'); const routineNameInput = document.getElementById('routineNameInput'); const setupModeRadios = document.querySelectorAll('input[name="setupMode"]'); const simpleSetupOptions = document.getElementById('simpleSetupOptions'); const advancedSetupOptions = document.getElementById('advancedSetupOptions'); const simpleTotalExercisesInput = document.getElementById('simpleTotalExercisesInput'); const simpleExerciseDurationInput = document.getElementById('simpleExerciseDurationInput'); const exerciseListContainer = document.getElementById('exerciseListContainer'); const addExerciseButton = document.getElementById('addExerciseButton'); const removeLastExerciseButton = document.getElementById('removeLastExerciseButton'); const restDurationInput = document.getElementById('restDurationInput'); const totalRoundsInput = document.getElementById('totalRoundsInput'); const restBetweenRoundsInput = document.getElementById('restBetweenRoundsInput'); const warmupDurationInput = document.getElementById('warmupDurationInput'); const cooldownDurationInput = document.getElementById('cooldownDurationInput'); const savedRoutinesSelect = document.getElementById('savedRoutinesSelect'); const saveRoutineButton = document.getElementById('saveRoutineButton'); const loadRoutineButton = document.getElementById('loadRoutineButton'); const deleteRoutineButton = document.getElementById('deleteRoutineButton'); const goToWorkoutButton = document.getElementById('goToWorkoutButton'); const clearAndShowInputButton = document.getElementById('clearAndShowInputButton'); const statusDisplay = document.getElementById('statusDisplay'); const exerciseNameDisplay = document.getElementById('exerciseNameDisplay'); const timerDisplay = document.getElementById('timerDisplay'); const currentProgress = document.getElementById('currentProgress'); const overallProgress = document.getElementById('overallProgress'); const estimatedTimeDisplay = document.getElementById('estimatedTimeDisplay'); const elapsedTimeDisplay = document.getElementById('elapsedTimeDisplay'); const roundDisplay = document.getElementById('roundDisplay'); const startButton = document.getElementById('startButton'); const pauseButton = document.getElementById('pauseButton'); const resetButton = document.getElementById('resetButton'); const skipButton = document.getElementById('skipButton'); const muteButton = document.getElementById('muteButton'); const backToSetupButton = document.getElementById('backToSetupButton'); const historyList = document.getElementById('historyList'); const bellSound = document.getElementById('bellSound');

            // --- State Variables (Gi·ªØ nguy√™n) ---
            let workoutConfig = { name: '', mode: 'simple', warmupDuration: 0, exercises: [], restDuration: 0, totalRounds: 1, restBetweenRoundsDuration: 0, cooldownDuration: 0, totalWorkoutTime: 0 }; let loadedRoutineData = null; let currentPhase = 'idle'; let currentExerciseIndex = -1; let currentRound = 1; let currentTimeRemaining = 0; let currentPhaseTotalDuration = 0; let timerIntervalId = null; let isPaused = false; let totalElapsedTime = 0; let workoutHistory = []; let savedRoutines = []; let settings = { muted: false };

            // --- Constants (Gi·ªØ nguy√™n) ---
            const HISTORY_STORAGE_KEY = 'flexWorkoutHistory_v6'; const ROUTINES_STORAGE_KEY = 'flexSavedRoutines_v6'; const SETTINGS_KEY = 'flexWorkoutSettings_v6'; const LAST_INPUTS_KEY = 'flexWorkoutLastInputs_v6'; const WARNING_THRESHOLD = 5; const READY_DURATION = 3;

            // ==============================
            // --- HELPER FUNCTIONS (Gi·ªØ nguy√™n) ---
            // ==============================
            function formatTime(totalSeconds) { if (isNaN(totalSeconds) || totalSeconds < 0) return "00:00"; const minutes = Math.floor(totalSeconds / 60); const seconds = Math.floor(totalSeconds % 60); return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`; }
            function calculateTotalWorkoutTime(config) { if (!config || !Array.isArray(config.exercises)) return 0; let totalTime = 0; totalTime += config.warmupDuration || 0; totalTime += config.cooldownDuration || 0; if (config.exercises.length > 0 && config.totalRounds > 0) { let singleRoundTime = 0; config.exercises.forEach((ex, index) => { singleRoundTime += ex.duration || 0; if (index < config.exercises.length - 1) { singleRoundTime += config.restDuration || 0; } }); totalTime += singleRoundTime * config.totalRounds; if (config.totalRounds > 1) { totalTime += (config.restBetweenRoundsDuration || 0) * (config.totalRounds - 1); } } totalTime += READY_DURATION * (config.totalRounds > 0 ? config.totalRounds : 0); return totalTime; }

            // ==============================
            // --- PAGE NAVIGATION & SOUND (Gi·ªØ nguy√™n) ---
            // ==============================
            function showPage(pageId) { console.log(`Switching to page: ${pageId}`); document.querySelectorAll('.page').forEach(page => page?.classList.remove('active')); const activePage = document.getElementById(pageId); if (activePage) activePage.classList.add('active'); else console.error(`Page element not found: ${pageId}`); }
            function loadSettings() { console.log("Loading settings..."); try { const savedSettings = localStorage.getItem(SETTINGS_KEY); if (savedSettings) { const parsed = JSON.parse(savedSettings); if (typeof parsed.muted === 'boolean') settings.muted = parsed.muted; } } catch (e) { console.error("Error loading settings:", e); } applyMuteState(); }
            function saveSettings() { try { localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings)); console.log("Settings saved:", settings); } catch (e) { console.error("Error saving settings:", e); } }
            function applyMuteState() { if (!muteButton || !bellSound) return; bellSound.muted = settings.muted; muteButton.textContent = settings.muted ? 'B·∫≠t √Çm' : 'T·∫Øt √Çm'; muteButton.classList.toggle('muted', settings.muted); }
            function toggleMute() { settings.muted = !settings.muted; applyMuteState(); saveSettings(); }
            function playBellSound() { if (bellSound && !bellSound.muted) { bellSound.currentTime = 0; bellSound.play().catch(error => console.warn("Audio play error:", error)); } }

            // ==============================
            // --- WORKOUT HISTORY (Gi·ªØ nguy√™n) ---
            // ==============================
            function loadHistory() { console.log("Loading history..."); try { const savedHistory = localStorage.getItem(HISTORY_STORAGE_KEY); if (savedHistory) { workoutHistory = JSON.parse(savedHistory); if (!Array.isArray(workoutHistory)) workoutHistory = []; } else workoutHistory = []; } catch (e) { console.error("Error loading history:", e); workoutHistory = []; } displayHistory(); }
            function saveHistory() { try { localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(workoutHistory)); } catch (e) { console.error("Error saving history:", e); } }
            function displayHistory() { if (!historyList) return; historyList.innerHTML = ''; if (workoutHistory.length === 0) { historyList.innerHTML = '<li>Ch∆∞a c√≥ l·ªãch s·ª≠ n√†o.</li>'; return; } for (let i = workoutHistory.length - 1; i >= 0; i--) { const entry = workoutHistory[i]; if (!entry?.timestamp || !entry.config || !Array.isArray(entry.config.exercises)) continue; const li = document.createElement('li'); const date = new Date(entry.timestamp); const formattedDate = !isNaN(date) ? date.toLocaleDateString('vi-VN') + ' ' + date.toLocaleTimeString('vi-VN') : 'Ng√†y l·ªói'; let details = `"${entry.config.name || 'Kh√¥ng t√™n'}" (${entry.config.mode === 'simple' ? 'ƒê∆°n gi·∫£n' : 'N√¢ng cao'})`; if(entry.config.warmupDuration > 0) details += ` | W:${entry.config.warmupDuration}s`; details += ` | ${entry.config.exercises.length} b√†i x ${entry.config.totalRounds || 1} v√≤ng`; details += ` (${entry.config.restDuration}s ngh·ªâ)`; if(entry.config.totalRounds > 1 && entry.config.restBetweenRoundsDuration > 0) details += ` (${entry.config.restBetweenRoundsDuration}s ngh·ªâ v√≤ng)`; if(entry.config.cooldownDuration > 0) details += ` | C:${entry.config.cooldownDuration}s`; const totalTime = calculateTotalWorkoutTime(entry.config); li.innerHTML = `<strong>${formattedDate}</strong><div class="history-details">${details} | T·ªïng TG: ${formatTime(totalTime)}</div>`; historyList.appendChild(li); } }
            function saveHistoryEntry() { if (!workoutConfig || workoutConfig.exercises.length === 0) return; console.log("Saving history entry..."); const configForHistory = JSON.parse(JSON.stringify(workoutConfig)); const now = new Date(); workoutHistory.push({ timestamp: now.toISOString(), config: configForHistory }); if(workoutHistory.length > 50) { workoutHistory.shift(); } saveHistory(); displayHistory(); }

            // ==============================
            // --- SETUP PAGE: UI VISIBILITY CONTROL (Gi·ªØ nguy√™n) ---
            // ==============================
            function showNewInputArea() { if (newWorkoutParamsSection) newWorkoutParamsSection.classList.remove('hidden'); if (loadedRoutineInfo) loadedRoutineInfo.classList.add('hidden'); if (saveRoutineButton) saveRoutineButton.disabled = false; loadedRoutineData = null; checkRoutineSelectState(); }
            function hideNewInputArea(routineName) { if (newWorkoutParamsSection) newWorkoutParamsSection.classList.add('hidden'); if (loadedRoutineInfo) { loadedRoutineInfo.innerHTML = `ƒê√£ t·∫£i c·∫•u h√¨nh: <strong>${routineName || 'Kh√¥ng t√™n'}</strong>. S·∫µn s√†ng ƒë·ªÉ Chu·∫©n b·ªã T·∫≠p.`; loadedRoutineInfo.classList.remove('hidden'); } if (saveRoutineButton) saveRoutineButton.disabled = true; }

            // ==============================
            // --- SETUP PAGE: MODE SWITCHING (Gi·ªØ nguy√™n) ---
            // ==============================
            function switchSetupMode(mode) { if (!simpleSetupOptions || !advancedSetupOptions) return; console.log("Switching setup mode to:", mode); if (mode === 'simple') { simpleSetupOptions.classList.add('active'); advancedSetupOptions.classList.remove('active'); } else { simpleSetupOptions.classList.remove('active'); advancedSetupOptions.classList.add('active'); if (exerciseListContainer.children.length === 0) { addExerciseInput(); } } updateRemoveLastButtonState(); }
            setupModeRadios.forEach(radio => { radio.addEventListener('change', (event) => { switchSetupMode(event.target.value); saveLastInputs(); }); });
            function getSelectedSetupMode() { const checkedRadio = document.querySelector('input[name="setupMode"]:checked'); return checkedRadio ? checkedRadio.value : 'simple'; }

            // ==============================
            // --- SETUP PAGE: ADVANCED EXERCISE LIST MGMT (Gi·ªØ nguy√™n) ---
            // ==============================
            function addExerciseInput(name = '', duration = '') { if (!exerciseListContainer) return; const exerciseCount = exerciseListContainer.children.length; const itemDiv = document.createElement('div'); itemDiv.classList.add('exercise-item'); const nameInput = document.createElement('input'); nameInput.type = 'text'; nameInput.placeholder = `T√™n B√†i ${exerciseCount + 1}`; nameInput.value = name; nameInput.dataset.type = 'name'; const durationInput = document.createElement('input'); durationInput.type = 'number'; durationInput.min = '1'; durationInput.placeholder = 'Gi√¢y'; durationInput.value = duration; durationInput.dataset.type = 'duration'; const removeBtn = document.createElement('button'); removeBtn.textContent = 'X√≥a'; removeBtn.type = 'button'; removeBtn.classList.add('btn-remove-exercise'); removeBtn.onclick = () => { itemDiv.remove(); updateRemoveLastButtonState(); saveLastInputs(); }; itemDiv.appendChild(nameInput); itemDiv.appendChild(durationInput); itemDiv.appendChild(removeBtn); exerciseListContainer.appendChild(itemDiv); updateRemoveLastButtonState(); }
            function removeLastExerciseInput() { if (exerciseListContainer && exerciseListContainer.lastElementChild) { exerciseListContainer.lastElementChild.remove(); } updateRemoveLastButtonState(); saveLastInputs(); }
            function updateRemoveLastButtonState() { if(removeLastExerciseButton && exerciseListContainer) { removeLastExerciseButton.disabled = exerciseListContainer.children.length === 0; } }
            function getExercisesFromDOM() { const exercises = []; if (exerciseListContainer) { const items = exerciseListContainer.querySelectorAll('.exercise-item'); items.forEach(item => { const nameInput = item.querySelector('input[data-type="name"]'); const durationInput = item.querySelector('input[data-type="duration"]'); const name = nameInput ? nameInput.value.trim() : ''; const duration = durationInput ? parseInt(durationInput.value, 10) : 0; if (duration > 0) { exercises.push({ name: name || `B√†i ${exercises.length + 1}`, duration: duration }); } }); } return exercises; }
            function populateExercisesToDOM(exercises) { if (!exerciseListContainer) return; exerciseListContainer.innerHTML = ''; if (Array.isArray(exercises)) { exercises.forEach(ex => { addExerciseInput(ex.name, ex.duration); }); } updateRemoveLastButtonState(); }

            // ==============================
            // --- SETUP PAGE: ROUTINE SAVE/LOAD (Gi·ªØ nguy√™n) ---
            // ==============================
            function loadRoutines() { console.log("Loading routines..."); try { const saved = localStorage.getItem(ROUTINES_STORAGE_KEY); if (saved) { savedRoutines = JSON.parse(saved); if (!Array.isArray(savedRoutines)) savedRoutines = []; } else savedRoutines = []; } catch (e) { console.error("Error loading routines:", e); savedRoutines = []; } populateRoutinesSelect(); }
            function saveRoutines() { try { savedRoutines.sort((a, b) => (a.name || '').localeCompare(b.name || '')); localStorage.setItem(ROUTINES_STORAGE_KEY, JSON.stringify(savedRoutines)); console.log("Routines saved."); } catch (e) { console.error("Error saving routines:", e); } populateRoutinesSelect(); }
            function populateRoutinesSelect() { if (!savedRoutinesSelect) return; const currentVal = savedRoutinesSelect.value; savedRoutinesSelect.innerHTML = '<option value="">-- Ch·ªçn ho·∫∑c Nh·∫≠p m·ªõi --</option>'; savedRoutines.forEach((routine, index) => { if (routine && routine.name && Array.isArray(routine.exercises)) { const option = document.createElement('option'); option.value = routine.name; let desc = `${routine.name} (${routine.mode === 'simple' ? 'ƒê∆°n gi·∫£n' : 'N√¢ng cao'}, ${routine.exercises.length} b√†i x ${routine.totalRounds || 1} v√≤ng)`; option.textContent = desc; savedRoutinesSelect.appendChild(option); } else { console.warn("Skipping invalid routine data:", routine); } }); savedRoutinesSelect.value = currentVal; if (!savedRoutinesSelect.value) { savedRoutinesSelect.value = ""; } checkRoutineSelectState(); }
            function checkRoutineSelectState() { if (!loadRoutineButton || !deleteRoutineButton || !savedRoutinesSelect) return; const selectedValue = savedRoutinesSelect.value; const routineExists = selectedValue && savedRoutines.some(routine => routine.name === selectedValue); loadRoutineButton.disabled = !routineExists; deleteRoutineButton.disabled = !routineExists; if(saveRoutineButton && newWorkoutParamsSection) { saveRoutineButton.disabled = newWorkoutParamsSection.classList.contains('hidden'); } }
            function handleSaveRoutine() { const name = routineNameInput.value.trim(); const selectedMode = getSelectedSetupMode(); let exercises = []; if (selectedMode === 'simple') { const totalEx = parseInt(simpleTotalExercisesInput.value, 10); const exDur = parseInt(simpleExerciseDurationInput.value, 10); if (isNaN(totalEx) || totalEx <= 0 || isNaN(exDur) || exDur <= 0) { alert("Ch·∫ø ƒë·ªô ƒê∆°n gi·∫£n: Vui l√≤ng nh·∫≠p T·ªïng s·ªë b√†i v√† Th·ªùi gian m·ªói b√†i h·ª£p l·ªá (l·ªõn h∆°n 0)."); return; } for (let i = 0; i < totalEx; i++) { exercises.push({ name: `B√†i ${i + 1}`, duration: exDur }); } } else { exercises = getExercisesFromDOM(); if (exercises.length === 0) { alert("Ch·∫ø ƒë·ªô N√¢ng cao: Vui l√≤ng th√™m √≠t nh·∫•t m·ªôt b√†i t·∫≠p v·ªõi th·ªùi gian l·ªõn h∆°n 0."); return; } } const restDur = parseInt(restDurationInput.value, 10) || 0; const rounds = parseInt(totalRoundsInput.value, 10) || 1; const restBetweenRounds = parseInt(restBetweenRoundsInput.value, 10) || 0; const warmup = parseInt(warmupDurationInput.value, 10) || 0; const cooldown = parseInt(cooldownDurationInput.value, 10) || 0; if (!name) { alert("Vui l√≤ng nh·∫≠p T√™n c·∫•u h√¨nh ƒë·ªÉ l∆∞u."); routineNameInput.focus(); return; } if (rounds <= 0) { alert("S·ªë v√≤ng t·∫≠p ph·∫£i l·ªõn h∆°n 0."); totalRoundsInput.focus(); return; } const newRoutine = { name: name, mode: selectedMode, warmupDuration: warmup, exercises: exercises, restDuration: restDur, totalRounds: rounds, restBetweenRoundsDuration: restBetweenRounds, cooldownDuration: cooldown }; const existingIndex = savedRoutines.findIndex(r => r.name.toLowerCase() === name.toLowerCase()); if (existingIndex !== -1) { if (confirm(`C·∫•u h√¨nh "${savedRoutines[existingIndex].name}" ƒë√£ t·ªìn t·∫°i. Ghi ƒë√®?`)) { savedRoutines[existingIndex] = newRoutine; } else { return; } } else { savedRoutines.push(newRoutine); } saveRoutines(); alert(`ƒê√£ l∆∞u c·∫•u h√¨nh "${name}".`); savedRoutinesSelect.value = name; checkRoutineSelectState(); }
            function handleLoadRoutine() { const selectedName = savedRoutinesSelect.value; if (!selectedName) return; const routineToLoad = savedRoutines.find(routine => routine.name === selectedName); if (routineToLoad) { console.log("Loading routine into state:", routineToLoad); loadedRoutineData = JSON.parse(JSON.stringify(routineToLoad)); hideNewInputArea(loadedRoutineData.name); alert(`ƒê√£ t·∫£i c·∫•u h√¨nh "${loadedRoutineData.name}". Nh·∫•n "Chu·∫©n b·ªã T·∫≠p" ƒë·ªÉ b·∫Øt ƒë·∫ßu.`); checkRoutineSelectState(); } else { alert("L·ªói: Kh√¥ng t√¨m th·∫•y c·∫•u h√¨nh."); loadedRoutineData = null; showNewInputArea(); loadRoutines(); } }
            function handleDeleteRoutine() { const selectedName = savedRoutinesSelect.value; if (!selectedName) return; if (confirm(`X√≥a vƒ©nh vi·ªÖn c·∫•u h√¨nh "${selectedName}"?`)) { const wasLoadedAndHidden = loadedRoutineData && loadedRoutineData.name === selectedName; savedRoutines = savedRoutines.filter(routine => routine.name !== selectedName); saveRoutines(); alert(`ƒê√£ x√≥a c·∫•u h√¨nh "${selectedName}".`); savedRoutinesSelect.value = ''; loadedRoutineData = null; if(wasLoadedAndHidden) { showNewInputArea(); handleClearInputsInternal(); } checkRoutineSelectState(); } }

            // ==============================
            // --- SETUP PAGE: INPUTS HANDLING (Gi·ªØ nguy√™n) ---
            // ==============================
            function handleClearInputsInternal() { console.log("Clearing input fields and resetting mode."); routineNameInput.value = ''; warmupDurationInput.value = '0'; restDurationInput.value = '15'; totalRoundsInput.value = '1'; restBetweenRoundsInput.value = '60'; cooldownDurationInput.value = '0'; simpleTotalExercisesInput.value = '5'; simpleExerciseDurationInput.value = '45'; populateExercisesToDOM([]); addExerciseInput(); document.querySelector('input[name="setupMode"][value="simple"]').checked = true; switchSetupMode('simple'); savedRoutinesSelect.value = ''; loadedRoutineData = null; updateRemoveLastButtonState(); checkRoutineSelectState(); try { localStorage.removeItem(LAST_INPUTS_KEY); } catch (e) { console.error("Error removing last inputs:", e); } }
            function handleClearAndShowInput() { console.log("Clear and Show Input button clicked."); showNewInputArea(); handleClearInputsInternal(); saveLastInputs(); }
            function saveLastInputs() { if (newWorkoutParamsSection && !newWorkoutParamsSection.classList.contains('hidden')) { const selectedMode = getSelectedSetupMode(); const lastInputs = { mode: selectedMode, name: routineNameInput.value, warmup: warmupDurationInput.value, simpleTotal: selectedMode === 'simple' ? simpleTotalExercisesInput.value : '', simpleDuration: selectedMode === 'simple' ? simpleExerciseDurationInput.value : '', advancedExercises: selectedMode === 'advanced' ? getExercisesFromDOM() : [], rest: restDurationInput.value, rounds: totalRoundsInput.value, roundRest: restBetweenRoundsInput.value, cooldown: cooldownDurationInput.value }; try { localStorage.setItem(LAST_INPUTS_KEY, JSON.stringify(lastInputs)); } catch(e) { console.error("Error saving last inputs:", e); } } else { console.log("Input area hidden, skipping saveLastInputs."); } }
            function loadLastInputs() { console.log("Loading last inputs..."); let inputsLoaded = false; try { const saved = localStorage.getItem(LAST_INPUTS_KEY); if (saved) { const lastInputs = JSON.parse(saved); const loadedMode = lastInputs.mode || 'simple'; document.querySelector(`input[name="setupMode"][value="${loadedMode}"]`).checked = true; switchSetupMode(loadedMode); routineNameInput.value = lastInputs.name || ''; warmupDurationInput.value = lastInputs.warmup || 0; restDurationInput.value = lastInputs.rest || 15; totalRoundsInput.value = lastInputs.rounds || 1; restBetweenRoundsInput.value = lastInputs.roundRest || 60; cooldownDurationInput.value = lastInputs.cooldown || 0; if (loadedMode === 'simple') { simpleTotalExercisesInput.value = lastInputs.simpleTotal || 5; simpleExerciseDurationInput.value = lastInputs.simpleDuration || 45; if (exerciseListContainer.children.length === 0) addExerciseInput(); } else { populateExercisesToDOM(lastInputs.advancedExercises || []); if (exerciseListContainer.children.length === 0) addExerciseInput(); } console.log("Last inputs loaded."); inputsLoaded = true; } } catch(e) { console.error("Error loading last inputs:", e); } if (!inputsLoaded) { document.querySelector('input[name="setupMode"][value="simple"]').checked = true; switchSetupMode('simple'); if (exerciseListContainer.children.length === 0) addExerciseInput(); } showNewInputArea(); updateRemoveLastButtonState(); }

            // =====================================
            // --- TRANSITION TO WORKOUT PAGE (Gi·ªØ nguy√™n) ---
            // =====================================
            function prepareAndSwitchToWorkout() { console.log("Preparing for workout..."); let configSource; if (loadedRoutineData) { console.log("Using loaded routine data."); configSource = loadedRoutineData; } else { console.log("Using data from input fields."); const selectedMode = getSelectedSetupMode(); let exercises = []; if (selectedMode === 'simple') { const totalEx = parseInt(simpleTotalExercisesInput.value, 10); const exDur = parseInt(simpleExerciseDurationInput.value, 10); if (isNaN(totalEx) || totalEx <= 0 || isNaN(exDur) || exDur <= 0) { alert("Ch·∫ø ƒë·ªô ƒê∆°n gi·∫£n: Vui l√≤ng nh·∫≠p T·ªïng s·ªë b√†i v√† Th·ªùi gian m·ªói b√†i h·ª£p l·ªá (l·ªõn h∆°n 0)."); return; } for (let i = 0; i < totalEx; i++) { exercises.push({ name: `B√†i ${i + 1}`, duration: exDur }); } } else { exercises = getExercisesFromDOM(); if (exercises.length === 0) { alert("Ch·∫ø ƒë·ªô N√¢ng cao: Vui l√≤ng th√™m √≠t nh·∫•t m·ªôt b√†i t·∫≠p v·ªõi th·ªùi gian l·ªõn h∆°n 0."); return; } } const name = routineNameInput.value.trim() || "B√†i t·∫≠p kh√¥ng t√™n"; const restDur = parseInt(restDurationInput.value, 10) || 0; const rounds = parseInt(totalRoundsInput.value, 10) || 1; const restBetweenRounds = parseInt(restBetweenRoundsInput.value, 10) || 0; const warmup = parseInt(warmupDurationInput.value, 10) || 0; const cooldown = parseInt(cooldownDurationInput.value, 10) || 0; if (rounds <= 0) { alert("S·ªë v√≤ng t·∫≠p ph·∫£i l·ªõn h∆°n 0."); totalRoundsInput.focus(); return; } configSource = { name: name, mode: selectedMode, warmupDuration: warmup, exercises: exercises, restDuration: restDur, totalRounds: rounds, restBetweenRoundsDuration: (rounds > 1) ? restBetweenRounds : 0, cooldownDuration: cooldown }; } workoutConfig = { name: configSource.name, mode: configSource.mode, warmupDuration: configSource.warmupDuration || 0, exercises: configSource.exercises || [], restDuration: configSource.restDuration || 0, totalRounds: configSource.totalRounds || 1, restBetweenRoundsDuration: configSource.restBetweenRoundsDuration || 0, cooldownDuration: configSource.cooldownDuration || 0, totalWorkoutTime: 0 }; workoutConfig.totalWorkoutTime = calculateTotalWorkoutTime(workoutConfig); console.log("Final workout config:", workoutConfig); if (workoutConfig.exercises.length === 0 || (workoutConfig.totalWorkoutTime <= 0 && workoutConfig.warmupDuration <= 0 && workoutConfig.cooldownDuration <= 0)) { alert("C·∫•u h√¨nh kh√¥ng h·ª£p l·ªá ho·∫∑c kh√¥ng c√≥ b√†i t·∫≠p n√†o. Kh√¥ng th·ªÉ b·∫Øt ƒë·∫ßu."); return; } estimatedTimeDisplay.textContent = formatTime(workoutConfig.totalWorkoutTime); resetTimerStateForNewWorkout(); showPage('workoutPage'); }

            // =====================================
            // --- WORKOUT PAGE LOGIC (UPDATED to remove 's') ---
            // =====================================
            function resetTimerStateForNewWorkout() { console.log("Resetting timer state for new workout."); clearInterval(timerIntervalId); timerIntervalId = null; currentPhase = 'idle'; currentExerciseIndex = -1; currentRound = 1; currentTimeRemaining = 0; currentPhaseTotalDuration = 0; isPaused = false; totalElapsedTime = 0; if (startButton && pauseButton && resetButton && backToSetupButton && skipButton) { startButton.textContent = 'B·∫Øt ƒë·∫ßu T·∫≠p'; startButton.classList.remove('hidden'); pauseButton.classList.add('hidden'); resetButton.disabled = true; skipButton.classList.add('hidden'); backToSetupButton.classList.remove('hidden'); } if(elapsedTimeDisplay) elapsedTimeDisplay.textContent = formatTime(0); if(roundDisplay) roundDisplay.textContent = `${currentRound}/${workoutConfig.totalRounds || '?'}`; if(exerciseNameDisplay) exerciseNameDisplay.textContent = ''; updateWorkoutPageDisplay(); }

            // --- UPDATE: B·ªè ch·ªØ 's' kh·ªèi timerDisplay.textContent ---
            function updateWorkoutPageDisplay() {
                 if (!timerDisplay || !statusDisplay || !currentProgress || !overallProgress || !elapsedTimeDisplay || !roundDisplay || !exerciseNameDisplay) return;
                 const seconds = Math.max(0, currentTimeRemaining);

                 // --- Update Timer Display (Number & Color) ---
                 // B·ªè ch·ªØ 's' ·ªü ƒë√¢y:
                 timerDisplay.textContent = `${Math.floor(seconds)}`; // Ch·ªâ hi·ªÉn th·ªã s·ªë

                 // Manage timer color classes (gi·ªØ nguy√™n)
                 timerDisplay.className = 'timer'; if (isPaused) { timerDisplay.classList.add('paused'); } else { timerDisplay.classList.add(`phase-${currentPhase}`); if (seconds > 0 && seconds <= WARNING_THRESHOLD && !['ready', 'idle', 'complete', 'warmup', 'cooldown'].includes(currentPhase)) { timerDisplay.classList.add('warning'); } }

                 // --- Update Status Text & Exercise Name (gi·ªØ nguy√™n) ---
                 let currentStatusText = ''; let currentExerciseName = '';
                 if (isPaused) { currentStatusText = `ƒê√£ t·∫°m d·ª´ng (V√≤ng ${currentRound}/${workoutConfig.totalRounds})`; if (currentPhase === 'exercise' && currentExerciseIndex >= 0) { currentExerciseName = workoutConfig.exercises[currentExerciseIndex]?.name || `B√†i ${currentExerciseIndex + 1}`; } else if (currentPhase === 'rest') { currentExerciseName = 'ƒêang ngh·ªâ'; } else if (currentPhase === 'roundRest') { currentExerciseName = 'Ngh·ªâ gi·ªØa v√≤ng'; } } else { switch (currentPhase) { case 'idle': currentStatusText = `S·∫µn s√†ng b·∫Øt ƒë·∫ßu`; break; case 'warmup': currentStatusText = `ƒêang kh·ªüi ƒë·ªông`; break; case 'ready': currentStatusText = `Chu·∫©n b·ªã cho V√≤ng ${currentRound}...`; if (currentExerciseIndex >= 0 && workoutConfig.exercises[currentExerciseIndex]) { currentExerciseName = `B√†i ti·∫øp theo: ${workoutConfig.exercises[currentExerciseIndex].name}`; } break; case 'exercise': currentStatusText = `ƒêang t·∫≠p (V√≤ng ${currentRound}/${workoutConfig.totalRounds})`; if (currentExerciseIndex >= 0) { currentExerciseName = workoutConfig.exercises[currentExerciseIndex]?.name || `B√†i ${currentExerciseIndex + 1}`; } break; case 'rest': currentStatusText = `ƒêang ngh·ªâ (V√≤ng ${currentRound}/${workoutConfig.totalRounds})`; const nextExIndex = currentExerciseIndex + 1; if(nextExIndex < workoutConfig.exercises.length) { currentExerciseName = `Ti·∫øp theo: ${workoutConfig.exercises[nextExIndex].name}`; } else { currentExerciseName = `Chu·∫©n b·ªã cho v√≤ng sau`; } break; case 'roundRest': currentStatusText = `ƒêang ngh·ªâ gi·ªØa v√≤ng (K·∫øt th√∫c V√≤ng ${currentRound})`; currentExerciseName = `Chu·∫©n b·ªã cho V√≤ng ${currentRound + 1}`; break; case 'cooldown': currentStatusText = `ƒêang gi√£n c∆°`; break; case 'complete': currentStatusText = "Ch√∫c m·ª´ng b·∫°n ƒë√£ ho√†n th√†nh!"; break; default: currentStatusText = "Tr·∫°ng th√°i kh√¥ng x√°c ƒë·ªãnh"; } } // K·∫øt th√∫c else (!isPaused)

                 // X·ª≠ l√Ω hi·ªÉn th·ªã khi ho√†n th√†nh (v·∫´n gi·ªØ nguy√™n icon üéâ)
                 if (currentPhase === 'complete') {
                    statusDisplay.textContent = "Ch√∫c m·ª´ng b·∫°n ƒë√£ ho√†n th√†nh!";
                     timerDisplay.textContent = "üéâ"; // Gi·ªØ nguy√™n icon ho√†n th√†nh
                     timerDisplay.classList.remove('warning', 'paused');
                     timerDisplay.classList.add('phase-exercise'); // M√†u xanh l√° khi ho√†n th√†nh
                 } else {
                    statusDisplay.textContent = currentStatusText;
                    exerciseNameDisplay.textContent = currentExerciseName;
                 }

                 // --- Update Progress Bars (gi·ªØ nguy√™n) ---
                 let currentProgressValue = 0; if (currentPhaseTotalDuration > 0 && currentPhase !== 'idle' && currentPhase !== 'complete') { currentProgressValue = ((currentPhaseTotalDuration - currentTimeRemaining) / currentPhaseTotalDuration) * 100; } else if (currentPhase === 'complete') { currentProgressValue = 100; } currentProgress.value = Math.min(100, Math.max(0, currentProgressValue));
                 let overallProgressValue = 0; if (workoutConfig.totalWorkoutTime > 0 && currentPhase !== 'idle') { overallProgressValue = (totalElapsedTime / workoutConfig.totalWorkoutTime) * 100; } overallProgress.value = Math.min(100, Math.max(0, overallProgressValue)); elapsedTimeDisplay.textContent = formatTime(totalElapsedTime);
                 if (currentPhase === 'complete') { currentProgress.value = 100; overallProgress.value = 100; elapsedTimeDisplay.textContent = formatTime(workoutConfig.totalWorkoutTime); }

                 // --- Update Round Display (gi·ªØ nguy√™n)---
                 roundDisplay.textContent = (currentPhase !== 'idle' && currentPhase !== 'complete') ? `${currentRound}/${workoutConfig.totalRounds}` : `--/--`;
            }
            // --- END UPDATE ---

            function triggerWorkoutCompletion() { console.log("Workout complete!"); clearInterval(timerIntervalId); timerIntervalId = null; currentPhase = 'complete'; isPaused = false; saveHistoryEntry(); updateWorkoutPageDisplay(); if (startButton && pauseButton && resetButton && backToSetupButton && skipButton) { startButton.classList.add('hidden'); pauseButton.classList.add('hidden'); resetButton.disabled = true; skipButton.classList.add('hidden'); backToSetupButton.classList.remove('hidden'); } playBellSound(); }
            function runTimerInterval() { if (isPaused || timerIntervalId === null || currentPhase === 'idle' || currentPhase === 'complete') return; currentTimeRemaining--; totalElapsedTime++; if (currentTimeRemaining < 0) { moveToNextPhase(); } else { updateWorkoutPageDisplay(); } }
            function moveToNextPhase() { console.log(`Phase ${currentPhase} ended. Moving to next.`); playBellSound(); let nextPhase = 'idle'; let nextDuration = 0; switch (currentPhase) { case 'warmup': nextPhase = 'ready'; nextDuration = READY_DURATION; currentExerciseIndex = 0; break; case 'ready': nextPhase = 'exercise'; if (currentExerciseIndex < 0 || currentExerciseIndex >= workoutConfig.exercises.length) currentExerciseIndex = 0; nextDuration = workoutConfig.exercises[currentExerciseIndex]?.duration || 0; break; case 'exercise': const isLastExerciseInRound = currentExerciseIndex >= workoutConfig.exercises.length - 1; if (isLastExerciseInRound) { if (currentRound >= workoutConfig.totalRounds) { if (workoutConfig.cooldownDuration > 0) { nextPhase = 'cooldown'; nextDuration = workoutConfig.cooldownDuration; } else { triggerWorkoutCompletion(); return; } } else { if (workoutConfig.restBetweenRoundsDuration > 0) { nextPhase = 'roundRest'; nextDuration = workoutConfig.restBetweenRoundsDuration; } else { currentRound++; currentExerciseIndex = 0; nextPhase = 'ready'; nextDuration = READY_DURATION; } } } else { if (workoutConfig.restDuration > 0) { nextPhase = 'rest'; nextDuration = workoutConfig.restDuration; } else { currentExerciseIndex++; nextPhase = 'exercise'; nextDuration = workoutConfig.exercises[currentExerciseIndex]?.duration || 0; } } break; case 'rest': currentExerciseIndex++; nextPhase = 'exercise'; nextDuration = workoutConfig.exercises[currentExerciseIndex]?.duration || 0; break; case 'roundRest': currentRound++; currentExerciseIndex = 0; nextPhase = 'ready'; nextDuration = READY_DURATION; break; case 'cooldown': triggerWorkoutCompletion(); return; case 'idle': case 'complete': resetTimerStateForNewWorkout(); return; default: console.error("Unknown phase transition from:", currentPhase); nextPhase = 'idle'; nextDuration = 0; } currentPhase = nextPhase; currentTimeRemaining = nextDuration; currentPhaseTotalDuration = nextDuration; updateWorkoutPageDisplay(); if (skipButton) { skipButton.classList.toggle('hidden', !['warmup', 'exercise', 'rest', 'roundRest', 'cooldown'].includes(currentPhase)); } if (pauseButton && !isPaused && currentPhase !== 'idle' && currentPhase !== 'complete' && currentPhase !== 'ready') { pauseButton.classList.remove('hidden'); } }
            function handleStartResumeClick() { if (!startButton || !pauseButton || !resetButton || !backToSetupButton || !skipButton) return; if (currentPhase === 'idle' || currentPhase === 'complete') { if (!workoutConfig || !workoutConfig.exercises || workoutConfig.exercises.length === 0 || (workoutConfig.totalWorkoutTime <= 0 && workoutConfig.warmupDuration <=0 && workoutConfig.cooldownDuration <=0) ) { alert("C·∫•u h√¨nh b√†i t·∫≠p kh√¥ng h·ª£p l·ªá ho·∫∑c ch∆∞a ƒë∆∞·ª£c t·∫£i/nh·∫≠p. Vui l√≤ng quay l·∫°i C√†i ƒë·∫∑t."); return; } } if (isPaused) { console.log("Resuming timer."); isPaused = false; if (!timerIntervalId) { timerIntervalId = setInterval(runTimerInterval, 1000); } startButton.classList.add('hidden'); pauseButton.classList.remove('hidden'); resetButton.disabled = false; skipButton.classList.toggle('hidden', !['warmup', 'exercise', 'rest', 'roundRest', 'cooldown'].includes(currentPhase)); backToSetupButton.classList.add('hidden'); } else if (currentPhase === 'idle' || currentPhase === 'complete') { console.log("Starting new workout sequence..."); resetTimerStateForNewWorkout(); totalElapsedTime = 0; let firstPhase = 'ready'; let firstDuration = READY_DURATION; currentExerciseIndex = 0; if (workoutConfig.warmupDuration > 0) { firstPhase = 'warmup'; firstDuration = workoutConfig.warmupDuration; currentExerciseIndex = -1; } currentPhase = firstPhase; currentTimeRemaining = firstDuration; currentPhaseTotalDuration = firstDuration; if (timerIntervalId) clearInterval(timerIntervalId); timerIntervalId = setInterval(runTimerInterval, 1000); startButton.classList.add('hidden'); pauseButton.classList.add('hidden'); resetButton.disabled = false; skipButton.classList.toggle('hidden', firstPhase !== 'warmup'); backToSetupButton.classList.add('hidden'); } updateWorkoutPageDisplay(); }
            function handlePauseClick() { if (!startButton || !pauseButton || !resetButton || !backToSetupButton || !skipButton) return; if (timerIntervalId !== null && !isPaused && !['idle', 'complete', 'ready'].includes(currentPhase)) { console.log("Pausing timer."); isPaused = true; pauseButton.classList.add('hidden'); startButton.classList.remove('hidden'); startButton.textContent = 'Ti·∫øp t·ª•c'; resetButton.disabled = false; skipButton.classList.add('hidden'); backToSetupButton.classList.remove('hidden'); updateWorkoutPageDisplay(); } }
            function handleResetClick() { if ((timerIntervalId !== null || isPaused) && currentPhase !== 'idle' && currentPhase !== 'complete') { if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën d·ª´ng v√† ƒë·∫∑t l·∫°i b√†i t·∫≠p hi·ªán t·∫°i kh√¥ng? Ti·∫øn tr√¨nh s·∫Ω b·ªã m·∫•t.")) { console.log("Resetting timer on workout page."); clearInterval(timerIntervalId); timerIntervalId = null; resetTimerStateForNewWorkout(); } } }
            function handleSkipClick() { if (timerIntervalId !== null && !isPaused && ['warmup', 'exercise', 'rest', 'roundRest', 'cooldown'].includes(currentPhase)) { console.log(`Skipping current phase: ${currentPhase}`); totalElapsedTime += Math.max(0, currentTimeRemaining); currentTimeRemaining = -1; updateWorkoutPageDisplay(); } }

            // ==============================
            // --- EVENT LISTENERS (Gi·ªØ nguy√™n) ---
            // ==============================
            function addSafeEventListener(element, event, handler, elementName) { if (element) { element.addEventListener(event, handler); } else { console.error(`${elementName || 'Element'} not found, cannot add listener for ${event}`); } }
            addSafeEventListener(addExerciseButton, 'click', () => { addExerciseInput(); saveLastInputs(); }, 'addExerciseButton'); addSafeEventListener(removeLastExerciseButton, 'click', removeLastExerciseInput, 'removeLastExerciseButton'); addSafeEventListener(goToWorkoutButton, 'click', prepareAndSwitchToWorkout, 'goToWorkoutButton'); addSafeEventListener(saveRoutineButton, 'click', handleSaveRoutine, 'saveRoutineButton'); addSafeEventListener(loadRoutineButton, 'click', handleLoadRoutine, 'loadRoutineButton'); addSafeEventListener(deleteRoutineButton, 'click', handleDeleteRoutine, 'deleteRoutineButton'); addSafeEventListener(clearAndShowInputButton, 'click', handleClearAndShowInput, 'clearAndShowInputButton');
            addSafeEventListener(savedRoutinesSelect, 'change', () => { if (savedRoutinesSelect.value === "") { showNewInputArea(); loadedRoutineData = null; } checkRoutineSelectState(); }, 'savedRoutinesSelect');
            const setupInputsToTrack = [ routineNameInput, warmupDurationInput, restDurationInput, totalRoundsInput, restBetweenRoundsInput, cooldownDurationInput, simpleTotalExercisesInput, simpleExerciseDurationInput ]; setupInputsToTrack.forEach(input => { addSafeEventListener(input, 'input', saveLastInputs, input?.id); }); if (exerciseListContainer) { exerciseListContainer.addEventListener('input', (event) => { if (event.target && (event.target.dataset.type === 'name' || event.target.dataset.type === 'duration')) { saveLastInputs(); } }); } setupModeRadios.forEach(radio => { addSafeEventListener(radio, 'change', saveLastInputs, radio.id); });
            addSafeEventListener(startButton, 'click', handleStartResumeClick, 'startButton'); addSafeEventListener(pauseButton, 'click', handlePauseClick, 'pauseButton'); addSafeEventListener(resetButton, 'click', handleResetClick, 'resetButton'); addSafeEventListener(skipButton, 'click', handleSkipClick, 'skipButton'); addSafeEventListener(muteButton, 'click', toggleMute, 'muteButton'); addSafeEventListener(backToSetupButton, 'click', () => { console.log("Back to Setup clicked."); if (currentPhase === 'idle' || currentPhase === 'complete' || isPaused) { if (isPaused) { if (!confirm("B√†i t·∫≠p ƒëang t·∫°m d·ª´ng. Quay l·∫°i c√†i ƒë·∫∑t s·∫Ω h·ªßy ti·∫øn tr√¨nh hi·ªán t·∫°i. Ti·∫øp t·ª•c?")) { return; } } clearInterval(timerIntervalId); timerIntervalId = null; resetTimerStateForNewWorkout(); showPage('setupPage'); } else { alert("Vui l√≤ng t·∫°m d·ª´ng ho·∫∑c d·ª´ng h·∫≥n b√†i t·∫≠p tr∆∞·ªõc khi quay l·∫°i C√†i ƒë·∫∑t."); } }, 'backToSetupButton');

            // ==============================
            // --- INITIALIZATION (Gi·ªØ nguy√™n) ---
            // ==============================
            console.log("App initializing..."); loadSettings(); loadLastInputs(); loadRoutines(); loadHistory(); checkRoutineSelectState(); updateRemoveLastButtonState(); showPage('setupPage'); console.log("App initialized.");

        }); // End of DOMContentLoaded
    </script>

</body>
</html>
